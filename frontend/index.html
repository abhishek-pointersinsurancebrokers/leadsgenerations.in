<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Secure Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
      /* Loader animation */
      .loader {
        border: 2px solid #f3f3f3;
        border-top: 2px solid #ff9500;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
        display: inline-block;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* OTP input styling */
      .otp-input {
        transition: all 0.2s ease;
      }
      
      .otp-input:focus {
        transform: scale(1.05);
        box-shadow: 0 0 0 3px rgba(255, 149, 0, 0.2);
      }
      
      /* WebOTP status indicator */
      .webotp-status {
        font-size: 12px;
        color: #6b7280;
        margin-top: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .webotp-status.active {
        color: #10b981;
      }
      
      .webotp-status.error {
        color: #ef4444;
      }
    </style>
  </head>

  <body
    class="min-h-screen h-screen w-full flex flex-col lg:flex-row overflow-hidden">
    <!-- Illustration Section -->
    <div
      class="w-full lg:w-[60%] h-[50vh] lg:h-full flex items-center justify-center p-6 order-1 lg:order-2">
      <img
        src="./assets/img/login-illustrator.svg"
        class="w-full h-full object-contain"
        alt="Login Illustration" />
    </div>

    <!-- Login Section -->
    <div
      class="w-full lg:w-[40%] h-[50vh] lg:h-full flex items-center justify-center p-6 lg:p-12 shadow-2xl order-2 lg:order-1 bg-white">
      <div class="w-full max-w-md">
        <!-- Phone Login Form -->
        <div id="phoneForm">
          <div class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800">
              Login into your account
            </h1>
            <p class="text-gray-600 mt-1">Secure login with OTP verification</p>
          </div>

          <form id="phoneFormElement" class="space-y-6">
            <div>
              <label class="block mb-2 text-gray-700 font-medium"
                >Phone Number</label
              >
              <div class="relative">
                <input
                  id="phone"
                  type="tel"
                  inputmode="tel"
                  autocomplete="tel"
                  class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-orange-500 bg-gray-100 focus:border-orange-500 outline-none placeholder:font-semibold"
                  placeholder="Enter your phone number" />

                <div
                  class="absolute inset-y-0 right-0 flex items-center px-4 bg-orange-500 rounded-r-lg">
                  <i class="fas fa-phone text-white"></i>
                </div>
              </div>
            </div>

            <button
              type="submit"
              id="request-otp-btn"
              class="w-full bg-orange-500 text-white py-3 rounded-lg font-semibold hover:bg-orange-600 transition-transform transform hover:scale-105 shadow-[0_8px_20px_rgba(0,0,0,0.35)]">
              Login Now
            </button>
          </form>
        </div>

        <!-- OTP Form -->
        <div id="otpForm" class="hidden">
          <div class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-800">OTP Verification</h1>
            <p class="text-gray-600 mt-1">Enter 4-digit OTP</p>
          </div>

          <form id="otpFormElement" class="space-y-6">
            <div class="flex justify-center space-x-3">
              <input
                id="otp1"
                maxlength="1"
                inputmode="numeric"
                autocomplete="one-time-code"
                class="otp-input w-12 h-12 text-center border rounded-lg bg-gray-100 text-xl font-bold focus:ring-2 focus:ring-orange-500" />
              <input
                id="otp2"
                maxlength="1"
                inputmode="numeric"
                autocomplete="one-time-code"
                class="otp-input w-12 h-12 text-center border rounded-lg bg-gray-100 text-xl font-bold focus:ring-2 focus:ring-orange-500" />
              <input
                id="otp3"
                maxlength="1"
                inputmode="numeric"
                autocomplete="one-time-code"
                class="otp-input w-12 h-12 text-center border rounded-lg bg-gray-100 text-xl font-bold focus:ring-2 focus:ring-orange-500" />
              <input
                id="otp4"
                maxlength="1"
                inputmode="numeric"
                autocomplete="one-time-code"
                class="otp-input w-12 h-12 text-center border rounded-lg bg-gray-100 text-xl font-bold focus:ring-2 focus:ring-2 focus:ring-orange-500" />
            </div>

            <!-- WebOTP Status Indicator -->
            <div id="webotpStatus" class="webotp-status">
              <i class="fas fa-info-circle mr-1"></i>
              <span id="webotpStatusText">Waiting for SMS...</span>
            </div>

            <button
              type="submit"
              id="verify-otp-btn"
              class="w-full bg-orange-500 text-white py-3 rounded-lg font-semibold hover:bg-orange-600 transition-transform transform hover:scale-105">
              Submit
            </button>

            <div class="text-center">
              <button
                type="button"
                id="resendOtp"
                class="text-orange-500 hover:text-orange-600 font-medium">
                Resend OTP
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Script -->
    <script>
      const phoneForm = document.getElementById("phoneForm");
      const otpForm = document.getElementById("otpForm");
      const otpInputs = document.querySelectorAll(".otp-input");
      const webotpStatus = document.getElementById("webotpStatus");
      const webotpStatusText = document.getElementById("webotpStatusText");
      
      // Track if WebOTP is active
      let webOTPActive = false;
      let webOTPTimer = null;

      // Show toast
      function showToast(message, color) {
        const toast = document.createElement("div");
        toast.className = `fixed top-4 right-4 bg-${color}-500 text-white px-6 py-3 rounded-lg shadow-lg transform translate-x-full transition-all duration-300 z-50`;
        toast.innerHTML = `<div class="flex items-center"><i class="fas fa-check-circle mr-2"></i>${message}</div>`;
        document.body.appendChild(toast);
        setTimeout(() => toast.classList.remove("translate-x-full"), 100);
        setTimeout(() => {
          toast.classList.add("translate-x-full");
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // Update WebOTP status
      function updateWebOTPStatus(message, type = 'normal') {
        if (webotpStatus && webotpStatusText) {
          webotpStatusText.textContent = message;
          webotpStatus.className = `webotp-status ${type}`;
        }
      }

      // Backend API URLs
      const API_BASE_URL = "https://leadsgenerations.in/api";
      //  const API_BASE_URL = "http://localhost:12000";
      const REQUEST_OTP_URL = `${API_BASE_URL}/auth/request-otp`;
      const VERIFY_OTP_URL = `${API_BASE_URL}/auth/verify-otp`;
      // const USER_STATUS_URL = `${API_BASE_URL}/auth/user-status`;

      // Phone form submit
      document
        .getElementById("phoneFormElement")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const phone = document.getElementById("phone").value.trim();

          if (!phone) {
            showToast("Please enter your phone number", "red");
            return;
          }

          // Disable button and show loading
          const requestOtpBtn = document.getElementById("request-otp-btn");
          requestOtpBtn.disabled = true;
          requestOtpBtn.innerHTML = '<span class="loader"></span> Checking...';

          try {
            // First check user status
            // const statusResponse = await fetch(USER_STATUS_URL, {
            //   method: "POST",
            //   headers: {
            //     "Content-Type": "application/json",
            //   },
            //   body: JSON.stringify({ phoneNumber: phone }),
            // });

            // const statusData = await statusResponse.json();
            // console.log("User status response:", statusData);

            // if (statusData.success && statusData.authStatus === 'login') {
            //   // User is already logged in, redirect to dashboard
            //   localStorage.setItem("user", JSON.stringify(statusData.user));
            //   showToast("login Successful!", "green");
            //   setTimeout(() => {
            //     window.location.href = "./pages/home.html";
            //   }, 1000);
            //   return;
            // }

            // If user is not logged in, proceed with OTP request
            requestOtpBtn.innerHTML = '<span class="loader"></span> Sending...';

            const response = await fetch(REQUEST_OTP_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ phoneNumber: phone }),
            });

            const data = await response.json();
            console.log("OTP request response:", data);

            if (data.success) {
              showToast(`OTP sent to ${phone}`, "green");

              // Show OTP section
              phoneForm.classList.add("hidden");
              otpForm.classList.remove("hidden");
              setTimeout(() => otpInputs[0].focus(), 300);
              
              // Initialize WebOTP API for auto-filling OTP
              initializeWebOTP(phone);
            } else {
              showToast(data.message || "Failed to send OTP", "red");
            }
          } catch (error) {
            showToast("Server error. Please try again.", "red");
            console.error("Error in OTP request:", error);
          } finally {
            // Reset button
            requestOtpBtn.disabled = false;
            requestOtpBtn.innerHTML = "Login Now";
          }
        });

      // OTP auto movement
      otpInputs.forEach((input, i) => {
        input.addEventListener("input", () => {
          input.value = input.value.replace(/[^0-9]/g, "");
          if (input.value && i < otpInputs.length - 1) otpInputs[i + 1].focus();
          
          // Check if all OTP fields are filled
          const allFilled = Array.from(otpInputs).every(inp => inp.value !== "");
          if (allFilled && !webOTPActive) {
            // Auto-submit the form when all fields are filled (only if WebOTP is not active)
            document.getElementById("otpFormElement").dispatchEvent(new Event("submit"));
          }
        });
        input.addEventListener("keydown", (e) => {
          if (e.key === "Backspace" && !input.value && i > 0)
            otpInputs[i - 1].focus();
        });
      });

      // OTP submit
      document
        .getElementById("otpFormElement")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const phone = document.getElementById("phone").value.trim();
          let otp = "";
          otpInputs.forEach((i) => (otp += i.value));

          if (otp.length !== 4) {
            showToast("Please enter the complete OTP", "red");
            return;
          }

          // Clear any WebOTP timer
          if (webOTPTimer) {
            clearTimeout(webOTPTimer);
            webOTPTimer = null;
          }

          // Disable button and show loading
          const verifyOtpBtn = document.getElementById("verify-otp-btn");
          verifyOtpBtn.disabled = true;
          verifyOtpBtn.innerHTML = '<span class="loader"></span> Verifying...';

          try {
            const response = await fetch(VERIFY_OTP_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ phoneNumber: phone, otp }),
            });

            const data = await response.json();
            console.log("OTP verification response:", data);

            if (data.success) {
              // Store user data in localStorage
              localStorage.setItem("user", JSON.stringify(data.user));

              showToast("OTP verified successfully!", "green");
              setTimeout(() => {
                window.location.href = "./pages/home.html";
              }, 1000);
            } else {
              showToast(data.message || "Invalid OTP", "red");
            }
          } catch (error) {
            showToast("Server error. Please try again.", "red");
            console.error("Error in OTP verification:", error);
          } finally {
            // Reset button
            verifyOtpBtn.disabled = false;
            verifyOtpBtn.innerHTML = "Submit";
          }
        });

      // Resend OTP
      document
        .getElementById("resendOtp")
        .addEventListener("click", async function () {
          const phone = document.getElementById("phone").value.trim();

          // Disable link temporarily
          this.disabled = true;
          this.textContent = "Sending...";

          // Clear any WebOTP timer
          if (webOTPTimer) {
            clearTimeout(webOTPTimer);
            webOTPTimer = null;
          }

          try {
            const response = await fetch(REQUEST_OTP_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ phoneNumber: phone }),
            });

            const data = await response.json();
            console.log("OTP resend response:", data);

            if (data.success) {
              showToast(`OTP resent to ${phone}`, "blue");
              // Reset OTP inputs
              otpInputs.forEach((input) => {
                input.value = "";
              });
              otpInputs[0].focus();
              
              // Reinitialize WebOTP API
              initializeWebOTP(phone);
            } else {
              showToast(data.message || "Failed to resend OTP", "red");
            }
          } catch (error) {
            showToast("Server error. Please try again.", "red");
            console.error("Error in OTP resend:", error);
          } finally {
            // Reset link
            this.disabled = false;
            this.textContent = "Resend OTP";
          }
        });

      // Allow only numbers in phone input
      document.getElementById("phone").addEventListener("input", function () {
        this.value = this.value.replace(/[^0-9]/g, "");
      });

      // Add paste functionality for OTP inputs
      otpInputs.forEach((input, index) => {
        input.addEventListener("paste", function (e) {
          e.preventDefault();
          const pastedData = e.clipboardData.getData("text").slice(0, 4);
          const digits = pastedData.split("");

          digits.forEach((digit, i) => {
            if (otpInputs[i]) {
              otpInputs[i].value = digit;
            }
          });

          // Focus the last filled input or the next empty one
          const lastIndex = Math.min(digits.length - 1, otpInputs.length - 1);
          otpInputs[lastIndex].focus();
          
          // Check if all OTP fields are filled after paste
          const allFilled = Array.from(otpInputs).every(inp => inp.value !== "");
          if (allFilled && !webOTPActive) {
            // Auto-submit the form when all fields are filled (only if WebOTP is not active)
            document.getElementById("otpFormElement").dispatchEvent(new Event("submit"));
          }
        });
      });

      // Initialize WebOTP API for auto-filling OTP
      function initializeWebOTP(phoneNumber) {
        // Reset WebOTP state
        webOTPActive = false;
        updateWebOTPStatus("Waiting for SMS...", "normal");
        
        // Check if WebOTP API is supported
        if (!('OTPCredential' in window)) {
          updateWebOTPStatus("Auto-fill not supported on this device", "error");
          console.log('WebOTP API not supported');
          return;
        }

        // Create AbortController for timeout
        const ac = new AbortController();
        
        // Set up timeout
        webOTPTimer = setTimeout(() => {
          ac.abort();
          updateWebOTPStatus("SMS request timed out", "error");
          console.log('WebOTP request timed out');
          webOTPActive = false;
        }, 5 * 60 * 1000); // 5 minutes timeout

        try {
          // Request OTP from SMS
          navigator.credentials.get({
            otp: { 
              transport: ['sms'],
              // This is critical - the SMS must contain your domain
              // Format: Your OTP is: 1234. @yourdomain.com #12345
            },
            signal: ac.signal
          }).then(otp => {
            clearTimeout(webOTPTimer);
            webOTPTimer = null;
            
            if (!otp || !otp.code) {
              updateWebOTPStatus("Invalid OTP format received", "error");
              console.error('Invalid OTP received');
              return;
            }
            
            // Extract OTP from the received credential
            const receivedOTP = otp.code.replace(/\D/g, ''); // Remove non-digits
            console.log('Received OTP:', receivedOTP);
            
            // Check if OTP is valid
            if (receivedOTP.length >= 4) {
              updateWebOTPStatus("OTP received!", "active");
              webOTPActive = true;
              
              // Fill the OTP inputs
              for (let i = 0; i < Math.min(4, receivedOTP.length); i++) {
                otpInputs[i].value = receivedOTP[i];
              }
              
              // Auto-submit the form after a short delay
              setTimeout(() => {
                document.getElementById("otpFormElement").dispatchEvent(new Event("submit"));
              }, 500);
            } else {
              updateWebOTPStatus("Invalid OTP length", "error");
              console.error('Invalid OTP length:', receivedOTP.length);
            }
          }).catch(err => {
            clearTimeout(webOTPTimer);
            webOTPTimer = null;
            webOTPActive = false;
            
            if (err.name === 'AbortError') {
              updateWebOTPStatus("SMS request timed out", "error");
              console.log('WebOTP request was aborted');
            } else {
              updateWebOTPStatus("Failed to read SMS", "error");
              console.error('WebOTP error:', err);
              
              // Log detailed error information
              if (err.message) {
                console.error('Error message:', err.message);
              }
            }
          });
        } catch (error) {
          clearTimeout(webOTPTimer);
          webOTPTimer = null;
          webOTPActive = false;
          updateWebOTPStatus("WebOTP initialization failed", "error");
          console.error('WebOTP initialization error:', error);
        }
      }

      // Log browser and device information for debugging
      console.log('Browser Information:');
      console.log('User Agent:', navigator.userAgent);
      console.log('WebOTP Support:', 'OTPCredential' in window);
      console.log('HTTPS:', window.location.protocol === 'https:');
    </script>
  </body>
</html>